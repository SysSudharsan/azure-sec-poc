{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "logAnalyticsServiceName": {
      "type": "string"
    },
    "environment": {
      "defaultValue": "dev",
      "type": "string"
    },
    "omsLocation": {
		"type": "string",
		"allowedValues": [
			"East US",
			"West Europe",
            "Southeast Asia",
            "Australia Southeast"
        ],
        "defaultValue": "East US"
    },
    "omsdataRetention": {
		"type": "int",
		"defaultValue": 90,
		"minValue": 7,
		"maxValue": 730,
		"metadata": {
			"description": "Number of days of retention. Free plans can only have 7 days, Standalone and OMS plans include 30 days for free"
		}
    },
   "workspaceSKU": {
       "type": "string",
       "allowedValues": [
			"Free",
			"Standalone",
			"PerNode"
		],
       "defaultValue": "Free",
       "metadata": {
			"description": "Service Tier: Free, Standalone, or PerNode"
		}
    },	
  },
  "variables": {
    "workspaceName": "[toLower(concat(parameters('logAnalyticsServiceName'),'-analytics-',parameters('environment')))]",
    "solutionNames": [
      "AzureWebAppsAnalytics",
      "AzureSQLAnalytics",
      "Security"
    ]
  },
	"resources": [	
    {
		"apiVersion": "2017-03-15-preview",
		"name": "[variables('workspaceName')]",
		"type": "Microsoft.OperationalInsights/workspaces",
		"location": "[parameters('omsLocation')]",
		"properties": {
             "sku": {
				"name": "[parameters('workspaceSKU')]"
			},
             "retention": "[parameters('omsdataRetention')]"
        }
    },
	{
		"id": "[concat(resourceGroup().id, '/providers/Microsoft.OperationsManagement/solutions/', variables('solutionNames')[copyIndex()], '(', variables('workspaceName'), ')')]",
		"type": "Microsoft.OperationsManagement/solutions",
		"name": "[concat(variables('solutionNames')[copyIndex()], '(', variables('workspaceName'), ')')]",
		"apiVersion": "2015-11-01-preview",
		"location": "[parameters('omsLocation')]",
		"dependsOn": [
			"[variables('workspaceName')]"
		],
		"copy": {
			"name": "copy-oms-solutions",
			"count": "[length(variables('solutionNames'))]"
		},
		"plan": {
			"name": "[concat(variables('solutionNames')[copyIndex()], '(', variables('workspaceName'), ')')]",
			"product": "[concat('OMSGallery/', variables('solutionNames')[copyIndex()])]",
			"promotionCode": "",
			"publisher": "Microsoft"
		},
		"properties": {
			"workspaceResourceId":  "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/', variables('workspaceName'))]"
		}
	}	
  ]
}